    @Value("${spring.security.oauth2.client.registration.google.client-id}")
    private String googleClientId;

    @Override
    public TokenResponse loginWithGoogle(String idTokenString) {
        try {
            GoogleIdTokenVerifier verifier = new GoogleIdTokenVerifier.Builder(
                    new NetHttpTransport(),
                    new GsonFactory())
                    .setAudience(Collections.singletonList(googleClientId))
                    .build();

            GoogleIdToken idToken = verifier.verify(idTokenString);

            if (idToken == null) {
                log.error("Invalid Google ID Token received");
                throw new BadRequestException("Invalid Google ID Token.");
            }

            GoogleIdToken.Payload payload = idToken.getPayload();
            String email = payload.getEmail();
            String googleId = payload.getSubject();
            String firstName = (String) payload.get("given_name");
            String lastName = (String) payload.get("family_name");
            String pictureUrl = (String) payload.get("picture");

            log.info("Google login successful for email: {}, googleId: {}", email, googleId);

            User user = userService.handleUpdateGoogleCredential(
                    googleId, email, firstName, lastName, pictureUrl);

            Map<String, String> map = jwtTokenProvider.generateRefreshTokenByUserId(
                    user.getId(),
                    null,
                    user.getRole().getValue(),
                    false);
            String refreshToken = map.get("refresh_token");
            String familyToken = map.get("family_token");

            String accessToken = jwtTokenProvider.generateAccessTokenByUserId(
                    user.getId(),
                    familyToken,
                    user.getRole().getValue());

            log.info("Generated tokens for user: {}", user.getId());

            return TokenResponse.builder()
                    .userId(user.getId())
                    .role(user.getRole().getValue())
                    .accessToken(accessToken)
                    .refreshToken(refreshToken)
                    .build();

        } catch (GeneralSecurityException | IOException e) {
            log.error("Google token verification failed", e);
            throw new BadRequestException("Invalid Google Token: " + e.getMessage());
        }
    }


    <dependency>
            <groupId>com.google.guava</groupId>
            <artifactId>guava</artifactId>
            <version>33.4.0-jre</version>
        </dependency>
        <dependency>
            <groupId>com.google.api-client</groupId>
            <artifactId>google-api-client</artifactId>
            <version>2.2.0</version>
        </dependency>
        <dependency>
            <groupId>com.google.oauth-client</groupId>
            <artifactId>google-oauth-client-jetty</artifactId>
            <version>1.34.1</version>
        </dependency>